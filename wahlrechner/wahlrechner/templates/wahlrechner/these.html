{% extends 'wahlrechner/base.html' %}
{% load wahlrechner_extras %}

{% block title %}These {{ index.0 }} von {{ index.1 }}{% endblock %}

{% block sidebar %}
    {% include "wahlrechner/sidebar.html" with icon_default="empty" url_template="these" %}
{% endblock %}

{% block content %}
    <div class="content lg:p-10">
        <div class="thesen-counter-container">
            <div class="these counter shift_for_icon">These {{ index.0 }} von {{ index.1 }}</div>
        </div>        

        <div class="these title">{{ these_current.these_text }}</div>

        {# Erhalte Position des Nutzers zu der These #}
        {% alias opinions|get_opinion:these_current as opinion %}

        <p class="these clue">
            {% if opinion and opinion != 's' %}
                Du hast dich bereits zu dieser These positioniert, aber du kannst deine Antwort noch anpassen:
            {% elif opinion == 's' %}
                Du hast diese These übersprungen, aber du kannst sie jetzt noch beantworten:
            {% else %}
                Bitte positioniere dich zu dieser These:
            {% endif %}
        </p>

        <div class="these btn-container">
            {% if opinion %}
                {# Wenn These bereits beantwortet, bleibe nach Auswahl auf der gleichen Seite #}
                {% url 'these' wahl.slug these_current.pk zustand_agree as url_agree %}
                {% url 'these' wahl.slug these_current.pk zustand_neutral as url_neutral %}
                {% url 'these' wahl.slug these_current.pk zustand_disagree as url_disagree %}
            {% elif these_next %}
                {# Wenn These noch nicht beantwortet, gehe nach Auswahl zur nächsten These #}
                {% url 'these' wahl.slug these_next.pk zustand_agree as url_agree %}
                {% url 'these' wahl.slug these_next.pk zustand_neutral as url_neutral %}
                {% url 'these' wahl.slug these_next.pk zustand_disagree as url_disagree %}
            {% else %}
                {# Wenn die letzte These beantwortet wird, und zuvor noch nicht beantwortet wurde #}
                {% url 'confirm' wahl.slug zustand_agree as url_agree %}
                {% url 'confirm' wahl.slug zustand_neutral as url_neutral %}
                {% url 'confirm' wahl.slug zustand_disagree as url_disagree %}
            {% endif %}

            <button onClick="location.href='{{ url_agree }}'"
                    class="btn btn-agree {% if opinion == "a" %}active{% endif %}" id="agree">
                {% include "snippets/icon.html" with icon="agree" color="white" %} stimme zu
            </button>
            <button onClick="location.href='{{ url_neutral }}'"
                    class="btn btn-neutral {% if opinion == "n" %}active{% endif %}" id="neutral">
                {% include "snippets/icon.html" with icon="neutral" color="white" %} neutral
            </button>
            <button onClick="location.href='{{ url_disagree }}'"
                    class="btn btn-disagree {% if opinion == "d" %}active{% endif %}" id="disagree">
                {% include "snippets/icon.html" with icon="disagree" color="white" %} stimme nicht zu
            </button>

            <!-- lz_a_1: Info-Button ; würde gehen, aber für NW_KOM_25 wieder deaktiviert-->
            <button onClick="" class="btn btn-background" id="background-button">
                Info
            </button>
        </div>

        <!-- lz_a_1: Sichtbarer Info-Bereich mit Erklärungstext -->
        <div id="background-info-section" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
            <div class="font-semibold text-blue-800 mb-2">Hintergrundinformation:</div>
            <div class="text-gray-700" id="background-info">
                {% if these_current.these_explainer %}
                    {{ these_current.these_explainer|linebreaks }}
                {% else %}
                    Es liegen leider keine extra Hintergrundinformation vor.
                {% endif %}
            </div>
        </div>
        
        <script>
            // lz_a_1: Neue Modal-Funktionalität
            const bgBtn = document.getElementById('background-button');
            /* const modal = document.getElementById('background-modal');
            const closeBtn = document.querySelector('.modal-close'); */

            bgBtn.addEventListener('click', () => {
                modal.style.display = 'flex';
                bgBtn.classList.add('active');

                setTimeout(() => {
                    bgBtn.classList.remove('active');
                }, 3000);
            });

            /* closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            }); */

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // lz_a_1: Toggle-Funktion mit Timeout für Farbänderung
            $('#background-button').click(function() {
                const infoSection = $('#background-info-section');
                const isVisible = !infoSection.hasClass('hidden');

                if (isVisible) {
                    infoSection.addClass('hidden');
                } else {
                    infoSection.removeClass('hidden');
                }

                // Füge 'active'-Klasse für visuelles Feedback hinzu
                $(this).addClass('active');

                // Entferne 'active'-Klasse nach 0,5 Sekunden
                setTimeout(() => {
                    $(this).removeClass('active');
                }, 500);
            });

            {# Keyboard Shortcuts #}
            $(document).keydown(function (event) {
                if (event.which === 65) {  // A
                    $('#agree').trigger('click');
                    event.preventDefault();
                } else if (event.which === 78) {  // N
                    $('#neutral').trigger('click');
                    event.preventDefault();
                } else if (event.which === 68) {  // D
                    $('#disagree').trigger('click');
                    event.preventDefault();
                } else if (event.which === 72) {  // H
                    $('#background-button').trigger('click');
                    event.preventDefault();
                }
            });
        </script>

    </div>

    <div class="btn-row">
        {% if these_prev %}
            {% url 'these' wahl.slug these_prev.pk zustand_current as url %}
            {% include "snippets/btn.html" with text="vorherige These" url=url icon="left" pos="l" sc="37" %}
        {% elif not opinions|get_opinion:thesen.last %}
            {# Leeres Div, um die restlichen Buttons korrekt anzuordnen #}
            <div class="-mb-2"></div>
        {% endif %}

        {% if opinions|get_opinion:thesen.last %}
            {% url 'confirm' wahl.slug zustand_current as url %}
            {% include "snippets/btn.html" with text="Abschließen" url=url icon="cright" pos="r" sc="70" %}
        {% endif %}

        {% if opinion and these_next %}
            {% url 'these' wahl.slug these_next.pk zustand_current as url %}
            {% include "snippets/btn.html" with text="nächste These" url=url icon="right" pos="r" sc="39" %}
        {% elif not opinion %}
            {% if these_next %}
                {% url 'these' wahl.slug these_next.pk zustand_skip as url %}
            {% else %}
                {% url 'confirm' wahl.slug zustand_skip as url %}
            {% endif %}
            {% include "snippets/btn.html" with text="These überspringen" url=url icon="skip" pos="r" sc="39" %}
        {% endif %}
    </div>

{% endblock %}

{% block shortcuts %}
    {# Erhalte Position des Nutzers zu der These #}
    {% alias opinions|get_opinion:these_current as opinion %}
    <li><span class="icon">A</span> stimme zu</li>
    <li><span class="icon">N</span> neutral</li>
    <li><span class="icon">D</span> stimme nicht zu</li>
    <li><span class="icon">H</span> Hintergrundinfo</li>
    {% if these_prev %}
        <li><span class="icon">&larr;</span> vorherige These</li>
    {% endif %}
    {% if opinion and these_next %}
        <li><span class="icon">&rarr;</span> nächste These</li>
    {% elif not opinion %}
        <li><span class="icon">&rarr;</span> These überspringen</li>
    {% endif %}
    {% if opinions|get_opinion:thesen.last %}
        <li><span class="icon">F</span> Abschließen</li>
    {% endif %}
{% endblock %}
