
services:
  caddy:
    container_name: caddy
    image: caddy:2.8
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      - main_app_network
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - ./caddy-logs:/var/log/caddy
      # Statische und Mediendateien f√ºr alle Wahlen (werden von Django gesammelt)
      - ./data/static:/www/static
      - ./data/media:/www/media
      - ./themes:/www/themes
    env_file:
      - ./caddy/caddy.env

  app:
    container_name: wahlrechner_app
    build:
      context: ../wahlrechner
    command: bash -c 'docker/wait-for-it/wait-for-it.sh db:3306 -t 120 -- docker/startup-production.sh'
    restart: always
    networks:
      - main_app_network
    volumes:
      # Statische und Mediendateien (Django sammelt nach /code/assets/ und /code/media/)
      - ./data/static:/code/assets/
      - ./data/media:/code/media/
      - ./data/logs:/code/logs/
      - ./data/stats:/code/wahlrechner/stats
      - ./themes:/code/themes
    env_file:
      - ./config/config.env
    depends_on:
      - db

  db:
    container_name: wahlrechner_db
    image: mariadb
    restart: always
    networks:
      - main_app_network
    env_file:
      - ./config/config.env
    volumes:
      - ./data/mysql:/var/lib/mysql

volumes:
  caddy_data:
  caddy_config:

networks:
  main_app_network:
    name: wahlcheck_app
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.108.0/24
